<div class="cart_section">
  <div class="container">
    <div class="row">
      <div class="col-lg-10 offset-lg-1">
        <div class="purchase-main">
          <ol class="progress-bar">
            <li class="progress-bar__steps current">
              <span class="progress-bar__steps--text ">Review your Order</span>
            </li>
            <li class="progress-bar__steps ">
              <span class="progress-bar__steps--text">Payment</span>
            </li>
            <li class="progress-bar__steps ">
              <span class="progress-bar__steps--text">Done</span>
            </li>
          </ol>
        </div>
      </div>
    </div>
    <div id="review-order-panel">
      <div class="row" id="address-group-penal">
        <div class="col-lg-10 offset-lg-1">
          <div class="adress-panel">
            <div class="default">
              <p>Default address</p>
            </div>
            <div class="panel-body">
              <div class="row">
                <input type="radio" checked>
                <label><%= current_user.shipping.name if current_user.shipping.present? %></label>
              </div>
              <div class="row">
                <div class="caption">
                  <img src="/assets/contact_3.png" alt="">
                  <p><%= "#{current_user.shipping.street_address_one}, #{current_user.shipping.street_address_two}" if current_user.shipping.present? %></p>
                  <p><%= "#{current_user.shipping.city}, #{current_user.shipping.state}, #{current_user.shipping.postal_code}"if current_user.shipping.present? %></p>
                  <p><%= current_user.shipping.cntry_name if current_user.shipping.present? %></p>
                </div>
              </div>
              <div class="row">
                <div class="caption">
                  <img src="/assets/phone.png" alt="">
                  <p><%= current_user.shipping.mobile if current_user.shipping.present? %></p>
                </div>
              </div>
            </div>
            <div class="edit">
              <a href="#" class="show-inputs-group">
                <span class="glyphicon glyphicon-pencil"></span>
                Edit
              </a>
            </div>
          </div>
          <a href="#" class="show-inputs-group">
            <span class="glyphicon glyphicon-plus"></span>
            Add a new address
          </a>
        </div>
      </div>
      <div class="row" id="form-inputs-group">
        <div class="col-lg-6 offset-lg-1">
          <%= simple_form_for @shipping, url: create_shipping_path, method: :post do |f| %>
            <div class="form-group row">
              <label class="form-label col-md-3">Contact Name:</label>
              <div class="col-md-9">
                <%= f.input :name, class: "form-control", label: false, required: true %>
              </div>
            </div>
            <div class="form-group row">
              <label class="form-label col-md-3">Country/Region:</label>
              <div class="col-md-9">
                <%= f.input :cntry_name, class: "form-control", label: false, required: true %>
<!--                <select class="form-control">-->
<!--                  <option value="example">example</option>-->
<!--                  <option value="example">example</option>-->
<!--                  <option value="example">example</option>-->
<!--                </select>-->
              </div>
            </div>

            <div class="form-group row">
              <label class="form-label col-md-3">Street Address:</label>
              <div class="col-md-9">
                <%= f.input :street_address_one, class: "form-control", label: false, required: true, prompt: "Street address" %>
                <%= f.input :street_address_two, class: "form-control", label: false, required: true, prompt: "Apartment, suite, unit etc. (optional)" %>
<!--                <input type="text" placeholder="Street address" class="form-control">-->
<!--                <input type="text" placeholder="Apartment, suite, unit etc. (optional)" class="form-control">-->
              </div>
            </div>

            <div class="form-group row">
              <label class="form-label col-md-3">State/Province:</label>
              <div class="col-md-9">
                <%= f.input :state, class: "form-control", label: false, required: true %>
<!--                <select class="form-control">-->
<!--                  <option value="example">example</option>-->
<!--                  <option value="example">example</option>-->
<!--                  <option value="example">example</option>-->
<!--                </select>-->
              </div>
            </div>
            <div class="form-group row">
              <label class="form-label col-md-3">City:</label>
              <div class="col-md-9">
                <%= f.input :city, class: "form-control", label: false, required: true %>
              </div>
            </div>
            <div class="form-group row">
              <label class="form-label col-md-3">Zip/Postal Code:</label>
              <div class="col-md-9">
                <%= f.input :postal_code, class: "form-control", label: false, required: true %>
<!--                <input type="text" class="form-control">-->
              </div>
            </div>
            <div class="form-group row">
              <label class="form-label col-md-3">Mobile:</label>
              <div class="col-md-9">
                <%= f.input :mobile, class: "form-control", label: false, required: true, id: "mobile_no" %>
<!--                <input type="text" class="form-control">-->
              </div>
            </div>
            <%= f.hidden_field :user_id, value: current_user.id %>

            </div>
            </div>
            <div class="row">
              <div class="col-lg-10 offset-lg-1">
                <div class="cart_buttons">

                  <%= link_to "Cancel", shop_path, class: "button cart_button_clear" %>
                  <%= f.submit 'Submit', class: "button cart_button_checkout" %>
                  <!--            <button type="button" class="button cart_button_checkout">Submit</button>-->
                </div>
              </div>
            </div>
          <% end %>
          </div>

    <div id="payment-panel">
      <div class="row">
        <div class="col-lg-10 offset-lg-1">
          <form action="">
            <div class="row">
              <div class="col-md-6">
                <div class="form-group">
                  <label class="card-label form-label">Card number:</label>
                  <input type="text" class="cc form-control" />
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-md-6">
                <div class="form-group">
                  <label class="form-label">Expiry Date:</label>
                  <div class="row">
                    <div class="col-md-5">
                      <input type="text" placeholder="MM" class="form-control" />
                    </div>
                    <div class="col-md-1">
                      <p class="divider">/</p>
                    </div>
                    <div class="col-md-5">
                      <input type="text" placeholder="YY" class="form-control" />
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-md-6">
                <div class="form-group">
                  <label class="form-label">Cardholder Name:</label>
                  <div class="row">
                    <div class="col-md-6">
                      <input type="text" placeholder="First Name" class="form-control" />
                    </div>
                    <div class="col-md-6">
                      <input type="text" placeholder="Last Name" class="form-control" />
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-lg-10 offset-lg-1">
                <div class="cart_buttons">
                  <button type="button" class="button cart_button_clear">Cancel</button>
                  <button type="button" class="button cart_button_checkout">Done</button>
                </div>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div id="payment-done-panel">
      <div class="row">
        <div class="col-lg-10 offset-lg-1">
          <div class="thanksforshoping">
            <img src="/assets/char_1.png" alt="">
            <p>Thanks for shoping with us</p>
          </div>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col-lg-10 offset-lg-1">
        <div class="cart_container">
          <div class="cart_title">Shopping Cart</div>
          <div class="cart_items">
            <ul class="cart_list">
              <% if !session[:shop_cart].nil? && session[:shop_cart].count > 0 %>
                <% session[:shop_cart].each do |product| %>
                  <li class="cart_item clearfix">
                    <div class="cart_item_image"><img src="<%= product_details(product[0].to_i).product_images.first.image.url(:thumb) if product_details(product[0].to_i).product_images.present? %>" alt=""></div>
                    <div class="cart_item_info d-flex flex-md-row flex-column justify-content-between">
                      <div class="cart_item_name cart_info_col">
                        <div class="cart_item_title">Name</div>
                        <div class="cart_item_text"><%= product_details(product[0].to_i).name %></div>
                      </div>
                      <div class="cart_item_color cart_info_col">
                        <div class="cart_item_title">Color</div>
                        <div class="cart_item_text"><span style="background-color:#999999;"></span>Silver</div>
                      </div>
                      <div class="cart_item_quantity cart_info_col">
                        <div class="cart_item_title">Quantity</div>
                        <div class="cart_item_text"><%= product[1] %></div>
                      </div>
                      <div class="cart_item_price cart_info_col">
                        <div class="cart_item_title">Price</div>
                        <div class="cart_item_text">$<%= product_details(product[0].to_i).price %></div>
                      </div>
                      <div class="cart_item_total cart_info_col">
                        <div class="cart_item_title">Total</div>
                        <div class="cart_item_text">$<%= product_details(product[0].to_i).price*product[1].to_i %></div>
                      </div>
                    </div>
                  </li>
                <% end %>
              <% else %>
                <% if @order_items.present? %>
                  <% @order_items.each do |product| %>
                    <li class="cart_item clearfix">
                      <div class="cart_item_image"><img src="<%= product_details(product.product_id).product_images.first.image.url(:thumb) if product_details(product.product_id).product_images.present? %>" alt=""></div>
                      <div class="cart_item_info d-flex flex-md-row flex-column justify-content-between">
                        <div class="cart_item_name cart_info_col">
                          <div class="cart_item_title">Name</div>
                          <div class="cart_item_text"><%= product_details(product.product_id).name %></div>
                        </div>
                        <div class="cart_item_color cart_info_col">
                          <div class="cart_item_title">Color</div>
                          <div class="cart_item_text"><span style="background-color:#999999;"></span>Silver</div>
                        </div>
                        <div class="cart_item_quantity cart_info_col">
                          <div class="cart_item_title">Quantity</div>
                          <div class="cart_item_text"><%= product.quantity %></div>
                        </div>
                        <div class="cart_item_price cart_info_col">
                          <div class="cart_item_title">Price</div>
                          <div class="cart_item_text">$<%= product_details(product.product_id).price %></div>
                        </div>
                        <div class="cart_item_total cart_info_col">
                          <div class="cart_item_title">Total</div>
                          <div class="cart_item_text">$<%= product_details(product.product_id).price*product.quantity %></div>
                        </div>
                      </div>
                    </li>
                  <% end %>
                <% end %>
              <% end %>
            </ul>
          </div>

          <!-- Order Total -->
          <div class="order_total">
            <div class="order_total_content text-md-right">
              <div class="order_total_title">Order Total:</div>
              <div class="order_total_amount">$<%= cart_total %></div>
            </div>
          </div>

          <div class="cart_buttons">
            <!--            <button type="button" class="button cart_button_clear">Checkout</button>-->
            <%#= link_to "Checkout", checkout_path, class: "button cart_button_checkout" %>
            <%= link_to "Continue Shopping", shop_path, class: "button cart_button_checkout" %>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<% if current_user.shipping.nil? %>
  <style>
    #address-group-penal{
      display: none;
    }
    #form-inputs-group{
      display: block;
    }
  </style>
<% end %>
<% if current_user.shipping.present? %>
  <style>
    #address-group-penal{
      display: block;
    }
    #form-inputs-group{
      display: none;
    }
  </style>
<% end %>
<script>
    $(".progress-bar").css("flex-direction","row");
    $('.show-inputs-group').click(function () {
        $('#address-group-penal').hide('slow');
        $('#form-inputs-group').show('slow');
    });
    $(document).ready(function () {
        var pro = document.getElementsByClassName('progress-bar');
        var liarray = pro[0].getElementsByTagName('li');
        for (var i = 0; i < liarray.length; i++) {
            if (i === 0 && liarray[i].className === 'progress-bar__steps current') {
                $('#review-order-panel').show();
                $('#payment-panel').hide();
                $('#payment-done-panel').hide();
            } else if (i === 1 && liarray[i].className === 'progress-bar__steps current') {
                $('#review-order-panel').hide();
                $('#payment-panel').show();
                $('#payment-done-panel').hide();
            } else if (i === 2 && liarray[i].className === 'progress-bar__steps current') {
                $('#review-order-panel').hide();
                $('#payment-panel').hide();
                $('#payment-done-panel').show();
            }
        }
    });

    function checkLuhn(input) {
        var sum = 0;
        var numdigits = input.length;
        var parity = numdigits % 2;
        for (var i = 0; i < numdigits; i++) {
            var digit = parseInt(input.charAt(i))
            if (i % 2 == parity) digit *= 2;
            if (digit > 9) digit -= 9;
            sum += digit;
        }
        return (sum % 10) == 0;
    };

    function detectCard(input) {
        var typeTest = 'undefined',
            ltest1 = 16,
            ltest2 = 16;
        if (/^4/.test(input)) {
            typeTest = 'visa';
            ltest1 = 13;
        } else if (/^5[1-5]/.test(input)) {
            typeTest = 'mastercard';
        } else if (/^3[4-7]/.test(input)) {
            typeTest = 'amex';
            ltest1 = 15;
            ltest2 = 15;
        } else if (/^6(011|4[4-9]|5)/.test(input)) {
            typeTest = 'discover';
        }
        return [typeTest, ltest1, ltest2];
    }


    $('input.cc').keyup(function () {
        var val = this.value,
            val = val.replace(/[^0-9]/g, ''),
            detected = detectCard(val),
            errorClass = '',
            luhnCheck = checkLuhn(val),
            valueCheck = (val.length == detected[1] || val.length == detected[2]);
        if (luhnCheck && valueCheck) {
            errorClass = 'verified';
        } else if (valueCheck || val.length > detected[2]) {
            errorClass = 'error';
        }

        $(this).attr('class', 'cc ' + detected[0] + ' ' + errorClass);
    });
    $("#shipping_mobile").intlTelInput({
        allowExtensions: true,
        autoFormat: true,
        autoHideDialCode: true,
        autoPlaceholder: true,
        preferredCountries: ['us', 'gb'],
        defaultCountry: 'auto',
        ipinfoToken: 'yolo',
        nationalMode: false,
        numberType: 'MOBILE',
        preventInvalidNumbers: true
    });
    var imageUrl = "/assets/flags@2x.png";
    $('.iti-flag').css('background-image', 'url(' + imageUrl + ')');
</script>